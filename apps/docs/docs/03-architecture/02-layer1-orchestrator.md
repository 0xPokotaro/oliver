---
id: layer1-orchestrator
title: "Layer 1: オーケストレーター"
sidebar_label: "Layer 1: オーケストレーター"
---

# Layer 1: Orchestrator

ユーザーインターフェースと文脈理解。

## 設計思想：思考と実務の分離

Oliverは、柔軟な対話を行う「人格層」と、厳格な処理を行う「能力層」を物理的・論理的に分離します。これにより、LLMの柔軟性を活かしつつ、Web3決済等の高セキュリティ領域での安全性を担保します。

Orchestratorは「人格層（Persona）」として、ユーザーとの対話、意図解釈（Contextual Understanding）、タスクの優先順位付けを担当します。秘密鍵や機密資産への直接アクセス権を持たず、常に特定のJSON形式で入出力を行う「状態遷移エンジン」として動作します。

## 役割

「ユーザーの意図（Intent）を理解し、指揮する脳」

### 責務

- **認知**: 音声(STT)から「ユーザーが今、何を望んでいるか」を抽出。
- **文脈保持**: ユーザーの好み、家族構成、過去の会話の流れを記憶。
- **意思決定**: 複数のL2モジュールのうち、どこにタスクを振るか（ルーティング）を決定。
- **フィードバック**: L2の結果を人間にわかりやすい言葉（TTS）で報告。

### 非責務

- 直接の決済署名
- 商品情報の詳細検索（これらはL2に任せる）
- 秘密鍵や機密資産への直接アクセス

## 共通データプロトコル（Unified JSON Interface）

人格層の入力と出力は、以下の共通JSONフォーマットに統一されます。

```json
{
  "context": {
    "session_id": "uuid",
    "status": "INPUT_RECEIVED | RESULT_RECEIVED | WAITING"
  },
  "thought": "AIによる内部推論プロセス（Chain of Thought）",
  "action": "TALK | EXECUTE",
  "tool": "呼び出す能力名（none | x402_payment | order_service etc.）",
  "params": {
    "key": "value（能力層への引数、または能力層からの返り値）"
  },
  "message": "ユーザーへ表示する自然文の返答"
}
```

### フィールド説明

- **context**: セッション管理と状態遷移を制御
- **thought**: AIの内部推論プロセス（デバッグや監査に有用）
- **action**: 次のアクションタイプ（`TALK`は対話継続、`EXECUTE`は能力層への実行指示）
- **tool**: 呼び出す能力層のモジュール名
- **params**: 能力層への引数、または能力層からの返り値
- **message**: ユーザーへ表示する自然文の返答

## 業務フロー（Operational Flow）

### 1. 意図解釈フェーズ

システムがユーザー発言を `params.user_input` に格納し、人格層へ入力します。人格層がJSONを更新し、情報の過不足を判断します。

### 2. 対話/確認フェーズ

情報不足時は `action: "TALK"` とし、ユーザーに質問を投げかけます。`message` フィールドに自然文の質問が格納されます。

### 3. 実行フェーズ

情報充足時、人格層が `action: "EXECUTE"` と `tool` を指定します。システムが能力層を起動し、能力層は `params` を元に署名・決済を実行します。

### 4. 完了報告フェーズ

能力層の実行結果を `action: "RESULT_RECEIVED"` として人格層へ再入力します。人格層が結果を解釈し、最終的な完了報告 `message` を生成します。

## セキュリティ設計（Design-by-Safety）

### 鍵の隔離（Sandboxing）

秘密鍵は「能力層」のセキュアな環境（TEE等）にのみ配置し、LLMが存在する「人格層」からは一切参照不可とします。

### ポリシーゲート

能力層の実行直前に、金額制限や宛先ホワイトリスト等のバリデーション（人間による最終承認または自動チェック）を介在させます。

### ステートレス性

人格層はJSONを受け取ってJSONを返すだけの純粋関数的に振る舞うことで、プロンプトインジェクションによる「状態の乗っ取り」を抑制します。

## 拡張性

能力層の追加: 新しいAPIやプロトコル（例：スマートホーム操作、旅行予約）を増やす際は、`tool` 名と `params` の定義を追加するだけで対応可能です。

マルチデバイス展開: 人格層の `message` は音声、チャット、通知など、出力先を選びません。

