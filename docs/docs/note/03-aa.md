# AA

## アカウントアブストラクション（ERC-4337）のフロー

```mermaid
sequenceDiagram
    participant User as 👤 User
    participant Bundler as 📦 Bundler
    participant EntryPoint as ⚙️ EntryPoint
    participant Account as 💼 Smart Account
    participant Paymaster as 💳 Paymaster (optional)
    participant Chain as ⛓️ Blockchain

    User->>Bundler: 1. UserOperationを作成・送信
    Note over User,Bundler: UserOperationには<br/>・sender (Account address)<br/>・calldata<br/>・signature<br/>・paymaster (optional)<br/>が含まれる

    Bundler->>Bundler: 2. simulateValidation()で<br/>検証ロジックをシミュレート
    Bundler->>EntryPoint: 3. handleOps(UserOp[])

    EntryPoint->>Account: 4. validateSignature(userOp, userOpHash)
    Account-->>EntryPoint: validationData (検証結果)

    alt Paymasterが使用される場合
        EntryPoint->>Paymaster: 5. validatePaymasterUserOp(userOp, userOpHash, maxCost)
        Paymaster-->>EntryPoint: context, validationData
    end

    EntryPoint->>Account: 6. execute(userOp.calldata)
    Note over Account: 実際の操作を実行<br/>(例: ERC20転送、コントラクト呼び出し等)
    Account-->>EntryPoint: 実行結果

    alt Paymasterが使用される場合
        EntryPoint->>Paymaster: 7. postOp(context, actualGasCost)
        Paymaster-->>EntryPoint: 処理完了
    end

    EntryPoint->>EntryPoint: 8. ガス代を精算
    EntryPoint->>Bundler: 9. 精算後の残額を返却
    EntryPoint->>Chain: 10. トランザクションをコミット
    Chain-->>User: ✅ 完了
```

## 主要コンポーネント

### UserOperation (UserOp)
ユーザーの操作を表現する構造体。以下を含む：
- `sender`: 実行するSmart Accountのアドレス
- `calldata`: 実行したい操作のデータ
- `signature`: ユーザーの署名
- `paymaster`: ガス代を肩代わりするPaymaster（オプション）

### Bundler
複数のUserOperationを集約し、EntryPointに送信するオフチェーンのサービス。検証のシミュレーションも行う。

### EntryPoint
ERC-4337の中心的なコントラクト。以下の役割を担う：
- UserOperationの検証・実行を統括
- Smart AccountとPaymasterとのやり取りを調整
- ガス代の精算を管理
- 各チェーンに1つだけデプロイされる

### Smart Account
ユーザーのウォレットを表すコントラクト。署名の検証と実際の操作の実行を行う。

### Paymaster (オプション)
ガス代をスポンサーするコントラクト。ガスレス体験を実現するために使用される。